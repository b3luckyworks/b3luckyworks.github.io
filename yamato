#!/usr/bin/env bash
# Yamato: minimaler Bootstrap ohne archinstall-Config
set -euo pipefail
[[ ! -t 0 && -r /dev/tty ]] && exec </dev/tty

is_archiso() { [[ -d /run/archiso ]] || grep -q '^VARIANT_ID=archiso' /etc/os-release 2>/dev/null; }

if [[ $EUID -ne 0 ]]; then
  echo "Bitte als root auf dem Arch-Live-ISO ausführen."; exit 1
fi

if ! is_archiso; then
  echo "[Yamato] Kein Arch-Live-ISO erkannt. Starte nur die Repo-Konfiguration…"
  curl -fsSL https://raw.githubusercontent.com/b3luckyworks/yamato/HEAD/scripts/install.sh -o /tmp/yamato-install.sh
  chmod +x /tmp/yamato-install.sh
  exec bash /tmp/yamato-install.sh client
fi

timedatectl set-ntp true || true
missing=()
for p in archinstall curl git; do pacman -Qq "$p" >/dev/null 2>&1 || missing+=("$p"); done
((${#missing[@]})) && pacman -Sy --noconfirm --needed "${missing[@]}"

echo
echo "Starte archinstall (ohne Config). Du wählst alles im TUI."
echo "Nach Abschluss kehrst du (falls kein Auto-Reboot) in diese Shell zurück."
echo

archinstall || { echo "archinstall abgebrochen/fehlgeschlagen."; exit 1; }

# First-Boot-Hook nur, wenn /mnt noch gemountet ist
if mount | grep -q ' on /mnt '; then
  echo "[Yamato] /mnt gefunden → First-Boot-Hook installieren…"

  cat >/mnt/usr/local/bin/yamato-firstboot.sh <<'EOF'
#!/usr/bin/env bash
set -eo pipefail
pick_user() {
  local u
  u="$(awk -F: '$3>=1000 && $1!="nobody"{print $1; exit}' /etc/passwd || true)"
  [[ -n "$u" ]] && { echo "$u"; return; }
  u="$(ls -1 /home 2>/dev/null | head -n1 || true)"
  echo "$u"
}
USER_NAME="$(pick_user)"
[[ -z "$USER_NAME" ]] && { echo "[yamato-firstboot] Kein Benutzer gefunden, beende."; exit 0; }
USER_HOME="$(getent passwd "$USER_NAME" | cut -d: -f6)"

REPO="https://github.com/b3luckyworks/yamato.git"
sudo -u "$USER_NAME" mkdir -p "$USER_HOME/git"
if [[ ! -d "$USER_HOME/git/yamato/.git" ]]; then
  sudo -u "$USER_NAME" git clone "$REPO" "$USER_HOME/git/yamato" || true
fi

if [[ -x "$USER_HOME/git/yamato/scripts/install.sh" ]]; then
  sudo -u "$USER_NAME" bash -lc '"$HOME/git/yamato/scripts/install.sh" client || true'
else
  echo "[yamato-firstboot] install.sh nicht gefunden – bitte später manuell ausführen."
fi

systemctl disable yamato-firstboot.service || true
EOF
  chmod 0755 /mnt/usr/local/bin/yamato-firstboot.sh

  cat >/mnt/etc/systemd/system/yamato-firstboot.service <<'EOF'
[Unit]
Description=Yamato First Boot Hook
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/yamato-firstboot.sh

[Install]
WantedBy=multi-user.target
EOF

  chroot /mnt systemctl enable yamato-firstboot.service 2>/dev/null || \
  arch-chroot /mnt systemctl enable yamato-firstboot.service

  echo "[Yamato] First-Boot-Hook aktiviert. Nach dem Reboot richtet sich Yamato automatisch ein."
else
  echo "[Yamato] /mnt nicht gefunden. Falls archinstall direkt rebootet hat, ist das okay."
  echo "Nach dem ersten Login bitte ausführen:"
  echo "  curl -fsSL https://raw.githubusercontent.com/b3luckyworks/yamato/HEAD/scripts/install.sh | bash -s -- client"
fi

echo
echo "Fertig. Jetzt rebooten und ins neue System starten."
